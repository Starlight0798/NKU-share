# åŒºå—é“¾åŸºç¡€åŠåº”ç”¨ 2023 Exercise 6

<div align=center>å§“åï¼šæå¸…ä¸œ&nbsp; å­¦å·ï¼š2111231&nbsp;</div>

<div align=center>å§“åï¼šé½æ˜æ°&nbsp; å­¦å·ï¼š2113997&nbsp;</div>

## å®éªŒç›®çš„

â€‹	åœ¨è¿™ä¸ªå®éªŒé‡Œï¼Œä½ ä¼šå­¦åˆ° circomï¼Œä¸€ä¸ªæè¿°ç®—æœ¯ç”µè·¯çš„å·¥å…· snarkjsï¼Œä¸€ç§ç”¨äºç”Ÿæˆå’ŒéªŒè¯ç”µè·¯æ»¡æ„åº¦çš„ zk-SNARKs çš„å·¥å…·ã€‚ æœ¬å®éªŒå»ºè®®ä½¿ç”¨ Ubuntu 20.04 ä»¥ä¸Šçš„ç‰ˆæœ¬è¿è¡Œã€‚

â€‹	ä½ å°†ä½¿ç”¨ä»¥ä¸‹çŸ¥è¯†æ¥æ¢ç´¢ç§æœ‰äº‹åŠ¡ï¼ˆprivate transactionsï¼‰çš„å®ç°ï¼š 

- åˆ¶ä½œä¸€ä¸ªç®€å•çš„ç‰ˆæœ¬çš„èŠ±è´¹ Tornado çš„ç”µè·¯

- ç”Ÿæˆèµå› Tornado çš„æœ‰æ•ˆæ€§è¯æ˜ã€‚

## å®éªŒæµç¨‹

### é…ç½®ç¯å¢ƒ

æ ¹æ®åŠ©æ•™ç»™çš„é…ç½®æ–‡ä»¶åŒ…ä¸­çš„æ­¥éª¤è¿›è¡Œé…ç½®ç¯å¢ƒã€‚

### äº†è§£`circom`

#### å›ç­”writeupå½“ä¸­çš„é—®é¢˜

**è¦æ±‚ï¼šå¡«å†™è‡³`artifacts/writeup.md`å½“ä¸­ã€‚**

**ä¸ºäº†æ–¹ä¾¿åŠ©æ•™å®¡é˜…ï¼Œæˆ‘å°†ä¸‰ä¸ªé—®é¢˜çš„ç­”æ¡ˆç²˜è´´åˆ°æ­¤å¤„ã€‚**

```APL
Answer1:
 `sum_of_bits` å®é™…ä¸Šåªæ˜¯è¾“å…¥ä¿¡å· `bits[i]` çš„çº¿æ€§ç»„åˆã€‚å…¶åŸå› åœ¨äº`2**i` ä¸æ˜¯ä¿¡å·ï¼Œè€Œåªæ˜¯ä¸€ä¸ªå¸¸é‡å€¼ï¼ˆç”±ä¾èµ–äº `n` çš„ `i` å®šä¹‰ï¼‰ã€‚
```

```APL
Answer2:
`<==` è¿ç®—ç¬¦åŸºæœ¬ä¸Šæ˜¯ `<--` å’Œ `===` è¿ç®—ç¬¦çš„ç»„åˆï¼Œå®ƒæ—¢åˆ†é…äº†ä¸€ä¸ªå€¼ç»™ä¿¡å·ï¼Œåˆæ„å‘³ç€ä»åˆ†é…ä¸­æ´¾ç”Ÿçš„åˆåŒæˆç«‹ã€‚å®ƒåŸºæœ¬ä¸Šåªæ˜¯ä¸€ç§å¿«æ·æ–¹å¼ï¼Œå…è®¸æˆ‘ä»¬åœ¨åˆ†é…ä¿¡å·çš„å€¼æ˜¯çº¿æ€§ç»„åˆæ—¶é¿å…ä½¿ç”¨ä¸¤ä¸ªè¿ç®—ç¬¦ã€‚
```

```apl
Answer3:
è¿™ä¸ªè¡¨è¾¾å¼ `(a & 1) * b === c` æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºå…¶ä¸­ä½¿ç”¨äº† `&` è¿ç®—ç¬¦ï¼Œè¡¨ç¤ºæŒ‰ä½ä¸æ“ä½œã€‚åœ¨ç”µè·¯çº¦æŸçš„ä¸Šä¸‹æ–‡ä¸­ï¼ŒæŒ‰ä½`&`æ“ä½œå¹¶ä¸èƒ½å¾—åˆ°è¾“å…¥ä¿¡å·çš„çº¿æ€§ç»„åˆï¼Œå› æ­¤çº¦æŸä¸èƒ½ç®€åŒ–ä¸ºrank-1å½¢å¼çš„ `a*b + c = 0`ã€‚å› æ­¤ï¼Œç»™å®šçš„è¡¨è¾¾å¼è¿åäº†åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æœ‰æ•ˆçº¦æŸçš„è¦æ±‚ã€‚
```

#### ä¸º`SmallOddFactorization`ç”µè·¯åˆ›å»º7\*17\*19=2261çš„è¯æ˜

**è¦æ±‚ï¼šå°†éªŒè¯å¯†é’¥`verifier key`ä¿å­˜åˆ°`artifacts/verifier_key_factor.json `,å°†è¯æ˜ä¿å­˜åˆ°`artifacts/proof_factor.json`**

- `SmallOddFactorization(n,b)`åœ¨`circuits/example.circom`å½“ä¸­ã€‚

- ä½¿ç”¨æŒ‡ä»¤`circom example.circom -o circuit.json`ç¼–è¯‘circuitï¼Œå¾—åˆ°`circuit.json`æ–‡ä»¶ã€‚

- åˆ›å»ºæ–°çš„æ–‡ä»¶ï¼Œåå­—ä¸º`input.json`ï¼Œè¿™ä¸ªè¾“å…¥æ–‡ä»¶æŒ‡å®šäº†`factors`æ•°ç»„å’Œ`product`çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¦è¯æ˜çš„çŸ¥è¯†å°±åœ¨è¿™é‡Œå¤´äº†ã€‚

  å…¶å†…å®¹å¦‚ä¸‹ï¼š

  ``` APL
  {
  "factors":[7,17,19],
  "product":2261
  }
  ```

- å°†ç¼–è¯‘å¥½çš„`circuit.json`æ‹–å…¥`snarkjs`

  - > `snarkjs info -c circuit.json`å¯ä»¥ç”¨æ¥æŸ¥çœ‹è¿™ä¸ªcircuitçš„å¸¸è§„æ•°æ®

  - > `snarkjs printconstraints -c circuit.json`å¯ä»¥ç”¨æ¥æ‰“å°è¿™ä¸ªcircuitçš„çº¦æŸ

  - ä½¿ç”¨æŒ‡ä»¤`snarkjs setup`æŒ‡ä»¤æ¥ä¸ºæˆ‘ä»¬çš„circuitè¿›è¡Œsetupã€‚è¿™ä¸ªæŒ‡ä»¤ä¼šå¯»æ‰¾`circuit.json`ã€‚å¦‚æœæƒ³è¦å¯»æ‰¾ç‰¹å®šçš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•°`-c <circuit JSON file name>`ã€‚

  - ä½¿ç”¨æŒ‡ä»¤`snarkjs calculatewitness`æ¥è®¡ç®—å‡ºwitnessï¼ˆç›®å‡»è¯äººï¼‰ï¼Œè¯´æ˜æˆ‘ä»¬ç¡®å®æœ‰è¿™ä¸ªçŸ¥è¯†.ï¼ˆçŸ¥è¯†å·²ç»åœ¨ä¸Šä¸€æ­¥éª¤ï¼Œ`input.json`é‡Œå¤´å†™å¥½äº†,è¿™æ¡æŒ‡ä»¤ä¾èµ–äº`input.json`è€Œæ‰§è¡Œï¼Œå› æ­¤ï¼Œå¿…é¡»è¦å…ˆå†™input.jsonå†æ‰§è¡ŒæŒ‡ä»¤ï¼‰ï¼Œä¹‹åï¼Œå°±ä¼šç”Ÿæˆ`witness.json`æ–‡ä»¶ã€‚

  - ä½¿ç”¨æŒ‡ä»¤`snarkjs proof`ç”Ÿæˆè¯æ®ã€‚è¿™æ¡æŒ‡ä»¤ä¼šé»˜è®¤åœ°ä½¿ç”¨`proving_key.json`å’Œ`witness.json`å»åˆ›å»º`proof.json`å’Œ`public.json`ã€‚å…¶ä¸­ï¼Œ`proof.json`æ–‡ä»¶ä¹‹ä¸­åŒ…å«ç€ç¡®å®çš„è¯æ®ã€‚`piblic.json`æ–‡ä»¶å°†ä¼šåŒ…å«å…¬å…±çš„è¾“å…¥å’Œå…¬å…±çš„è¾“å‡º

![image-20231212201621101](assets\image-20231212201621101.png)


åˆ°æ­¤ï¼Œæˆ‘ä»¬å°±æœ‰äº†æˆ‘ä»¬çš„éªŒè¯å¯†é’¥å’Œè¯æ®ã€‚è¯¦è§`artifacts/verifier_key_factor.json`ä¸ºéªŒè¯å¯†é’¥ï¼Œ`artifacts/proof_factor.json`ä¸ºè¯æ®ã€‚

ä½¿ç”¨`snarkjs verify`éªŒè¯ï¼Œå¾—åˆ°OKï¼

![image-20231212203906028](assets\image-20231212203906028.png)

### å¼€å…³ç”µè·¯

#### `circuits/spend.circom`:IfThenElse

```json
template IfThenElse() {
    signal input condition;
    signal input true_value;
    signal input false_value;
    signal output out;

    // TODO
    // Hint: You will need a helper signal...
    // æ¡ä»¶å¿…é¡»ä¸º0æˆ–1ã€‚
    condition * (1 - condition) === 0;

    // ä¸­é—´ä¿¡å·å€¼ï¼Œå› ä¸ºçº¦æŸå¿…é¡»ä¸ºab + c = 0çš„å½¢å¼
    signal diff <-- true_value - false_value;

    // åœ¨æ¡ä»¶ä¸º1çš„æƒ…å†µä¸‹ï¼Œæœ‰ï¼šout = 1 * (true_value - false_value) + false_value = true_value
    // åœ¨æ¡ä»¶ä¸º0çš„æƒ…å†µä¸‹ï¼Œæœ‰ï¼šout = 0 * (true_value - false_value) + false_value = false_value
    out <== condition * diff + false_value;
}
```

`IfThenElseï¼ˆï¼‰`è¦æ±‚ï¼Œå¦‚æœconditionä¸º1ï¼Œoutå°±æ˜¯true_value;å¦‚æœconditionä¸º0ï¼Œoutå°±æ˜¯false_value.

`condition*(1-condition)===0`å¼ºåˆ¶æ¡ä»¶ä¿¡å· å¿…é¡»ä¸º0æˆ–1ï¼›

ä¹‹åï¼Œæ ¹æ® `out=ï¼ˆtrue_value-false_valueï¼‰*condition+false_value`ï¼Œç›´æ¥å°†`out`è½¬åŒ–ä¸º`true_value`å’Œ`false_value`çš„çº¿æ€§è¡¨è¾¾ã€‚æˆ‘ä»¬ä¸éš¾éªŒè¯ï¼Œå½“conditionä¸º1æ—¶ï¼Œouttrue_value;å½“conditionä¸º0æ—¶ï¼Œoutfalse_value.

#### `circuits/spend.circom`:SelectiveSwitch

```json
template SelectiveSwitch() {
    signal input in0;
    signal input in1;
    signal input s;
    signal output out0;
    signal output out1;

    // TODO
    // å¼ºåˆ¶ s ä¸º 0 æˆ– 1ã€‚
    s * (1 - s) === 0;

    // ä½¿ç”¨ä¸¤ä¸ª if è¯­å¥ç¡®å®šè¾“å‡ºå€¼ã€‚

    // å¦‚æœ (s == 1) åˆ™è¾“å‡º in1ï¼Œå¦åˆ™è¾“å‡º in0
    component firstOutput = IfThenElse();
    firstOutput.condition <== s;
    firstOutput.true_value <== in1;
    firstOutput.false_value <== in0;

    // å¦‚æœ (s == 1) åˆ™è¾“å‡º in0ï¼Œå¦åˆ™è¾“å‡º in1
    component secondOutput = IfThenElse();
    secondOutput.condition <== s;
    secondOutput.true_value <== in0;
    secondOutput.false_value <== in1;

    // è¾“å‡ºä¿¡å·å¿…é¡»ç­‰äº if è¯­å¥çš„ç»“æœ
    out0 <== firstOutput.out;
    out1 <== secondOutput.out;
}
```

è¯¥å‡½æ•°å®ç°äº†é€‰æ‹©æ€§å¼€å…³ï¼Œæ ¹æ®è¾“å…¥çš„é€‰æ‹©ä¿¡èµ–æ¥è¾“å‡ºä¸åŒçš„å€¼ã€‚

- `s*(1-s)===0`æ˜¯è¦å¼ºåˆ¶çš„é€‰æ‹©ä¿¡å·sä¸º0æˆ–1.

- ç„¶åï¼Œä½¿ç”¨ä¸¤ä¸ª`IfThenElse()`ç»„ä»¶ï¼Œæ ¹æ®ä¿¡å·sçš„å€¼æ¥ç¡®å®šè¾“å‡ºå€¼ã€‚
  - ç¬¬ä¸€ä¸ªç»„ä»¶`firstOutput`æ˜¯æ ¹æ®sçš„å€¼æ¥é€‰æ‹©è¾“å‡ºin1æˆ–in0
  - ç¬¬äºŒä¸ªç»„ä»¶`SecondOutput`æ˜¯æ ¹æ®é€‰æ‹©ä¿¡å·sçš„å€¼æ¥è¾“å‡ºin1æˆ–in0
- æœ€åï¼Œå°†ä»¥ä¸Šä¸¤ä¸ªç»„ä»¶çš„è¾“å‡ºè¿æ¥åˆ°è¾“å‡ºä¿¡å·out0å’Œout1ä¸Šã€‚

ä¸éš¾éªŒè¯ï¼š

- sä¸º1æ—¶ï¼Œç¬¬ä¸€ä¸ªç»„ä»¶è¾“å‡ºout0ä¸ºin1ï¼›ç¬¬äºŒä¸ªç»„ä»¶è¾“å‡ºout1ä¸ºin0ï¼›
- sä¸º0æ—¶ï¼Œç¬¬ä¸€ä¸ªç»„ä»¶è¾“å‡ºout0ä¸ºin0ï¼›ç¬¬äºŒä¸ªç»„ä»¶è¾“å‡ºout1ä¸ºin1ï¼›

### æ¶ˆè´¹ç”µè·¯

#### `circuits/spend.circom `:Spend

```json
template Spend(depth) {
    signal input digest;
    signal input nullifier;
    signal private input nonce;
    signal private input sibling[depth];
    signal private input direction[depth];

    // TODO
    // åœ¨æ¯ä¸ªçº§åˆ«çš„outä¿¡å·ä¸­å­˜å‚¨æˆ‘ä»¬è®¡ç®—çš„è¯æ˜å“ˆå¸Œå€¼
    // éœ€è¦+1æ¥ä¿å­˜æ ¹èŠ‚ç‚¹
    component computed_hash[depth + 1];

    // ç¬¬0çº§åªæ˜¯H(`nullifier`, `digest`)
    computed_hash[0] = Mimc2();
    computed_hash[0].in0 <== nullifier; 
    computed_hash[0].in1 <== nonce;

    // å­˜å‚¨è·¯å¾„ä¸Šçš„å¼€å…³
    component switches[depth];

    // è®¾ç½®è¯æ˜è·¯å¾„ä¸Šçš„çº¦æŸ
    for (var i = 0; i < depth; ++i) {
        switches[i] = SelectiveSwitch();
        // å¦‚æœdirections[i]ä¸ºtrueï¼Œæˆ‘ä»¬å°†è®¡ç®—H(sibling[i], computed_hash[i])
        // å¦‚æœä¸ºfalseï¼Œåˆ™ä¸äº¤æ¢å¹¶è®¡ç®—H(computed_hash[i], sibling[i])
        switches[i].in0 <== computed_hash[i].out;
        switches[i].in1 <== sibling[i];
        switches[i].s <== direction[i];

        // è®¡ç®—ä¸‹ä¸€çº§çš„å“ˆå¸Œå€¼
        computed_hash[i + 1] = Mimc2();
        computed_hash[i + 1].in0 <== switches[i].out0;
        computed_hash[i + 1].in1 <== switches[i].out1;
    }

    // éªŒè¯digestæ˜¯å¦ä¸æœ€ç»ˆå“ˆå¸Œå€¼åŒ¹é…
    computed_hash[depth].out === digest;
}
```

- **å‡½æ•°çš„ç›®çš„**

â€‹	åœ¨è¿™ä¸ª`Spend`å‡½æ•°ä¸­ï¼Œç›®çš„æ˜¯éªŒè¯ç”±`nullifier`å’Œ`nonce`ç”Ÿæˆçš„ç‰¹å®šå“ˆå¸Œå€¼ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º`coin`ï¼‰ï¼Œæ˜¯å¦ä¸ºMerkleæ ‘çš„ä¸€éƒ¨åˆ†ã€‚è¿™æ˜¯é€šè¿‡æ„å»ºä»å¶å­åˆ°æ ‘æ ¹çš„è·¯å¾„å¹¶éªŒè¯å…¶æ­£ç¡®æ€§æ¥å®ç°çš„ã€‚

- **ä»£ç è§£æ**

1. **å®šä¹‰è¾“å…¥å’Œè¾“å‡º**ï¼š
	- `digest`ï¼šMerkleæ ‘çš„æ ¹å“ˆå¸Œå€¼ã€‚
	- `nullifier`ï¼šç”¨äºç”Ÿæˆç¡¬å¸å“ˆå¸Œå€¼çš„ä¸€éƒ¨åˆ†ã€‚
	- `nonce`ï¼šç¡¬å¸å“ˆå¸Œçš„å¦ä¸€éƒ¨åˆ†ï¼ˆç§æœ‰è¾“å…¥ï¼‰ã€‚
	- `sibling[depth]`å’Œ`direction[depth]`ï¼šå®šä¹‰äº†ä»ç¡¬å¸åˆ°Merkleæ ¹çš„è·¯å¾„ã€‚
2. **åˆå§‹åŒ–å“ˆå¸Œè®¡ç®—**ï¼š
	- `computed_hash[0]`ï¼šè¿™æ˜¯ç¡¬å¸çš„åˆå§‹å“ˆå¸Œå€¼ï¼Œç”±`Mimc2()`å‡½æ•°è®¡ç®—ï¼Œè¾“å…¥ä¸º`nullifier`å’Œ`nonce`ã€‚
3. **æ„å»ºè·¯å¾„**ï¼š
	- è¿™ä¸€éƒ¨åˆ†æ˜¯æ ¸å¿ƒã€‚å‡½æ•°é€šè¿‡å¾ªç¯`depth`æ¬¡ï¼Œé€å±‚æ„å»ºä»ç¡¬å¸å“ˆå¸Œåˆ°Merkleæ ¹çš„è·¯å¾„ã€‚
	- åœ¨æ¯ä¸ªçº§åˆ«ï¼Œä½¿ç”¨`SelectiveSwitch`ç»„ä»¶æ¥ç¡®å®šæ˜¯å¦éœ€è¦äº¤æ¢å…„å¼ŸèŠ‚ç‚¹çš„ä½ç½®ã€‚`direction[i]`å€¼å†³å®šäº†æ˜¯ä½¿ç”¨å·¦å…„å¼Ÿï¼ˆ`sibling[i]`ï¼‰è¿˜æ˜¯å³å…„å¼Ÿä½œä¸ºå½“å‰å±‚çš„å“ˆå¸Œè®¡ç®—è¾“å…¥ã€‚
	- åœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œéƒ½ä¼šè®¡ç®—å‡ºæ–°çš„å“ˆå¸Œå€¼ï¼ˆ`computed_hash[i + 1]`ï¼‰ï¼Œè¿™æ˜¯é€šè¿‡`Mimc2()`å‡½æ•°è®¡ç®—çš„ï¼Œè¾“å…¥ä¸ºé€‰æ‹©å¼€å…³çš„è¾“å‡ºã€‚
4. **éªŒè¯Merkleæ ¹**ï¼š
	- åœ¨å¾ªç¯ç»“æŸåï¼Œ`computed_hash[depth]`åº”è¯¥æ˜¯æ•´ä¸ªMerkleæ ‘çš„æ ¹å“ˆå¸Œã€‚è¿™ä¸ªå“ˆå¸Œå€¼è¢«ä¸è¾“å…¥çš„`digest`è¿›è¡Œæ¯”è¾ƒï¼Œä»¥éªŒè¯ç¡¬å¸æ˜¯å¦ç¡®å®å­˜åœ¨äºMerkleæ ‘ä¸­ã€‚

### è®¡ç®—èŠ±è´¹ç”µè·¯çš„è¾“å…¥

#### `src/compute_spend_input.js`

```js
function computeInput(depth, transcript, nullifier) {
    // TODO
    const tree = new SparseMerkleTree(depth);

    // å­˜å‚¨æˆ‘ä»¬æƒ³è¦ç”ŸæˆéªŒè¯çš„ç»™å®š nullifier å¯¹åº”çš„ commitmentã€‚
    let input_commitment, input_nonce = [null, null];

    // å°† transcript æ·»åŠ åˆ°æ ‘ä¸­ã€‚
    for (let i = 0; i < transcript.length; i++) {
      const commitment_or_info = transcript[i];
      let commitment = null;
      if (commitment_or_info.length == 1) {
        commitment = commitment_or_info[0];
      } else if (commitment_or_info.length == 2) {
        const [t_nullifier, nonce] = commitment_or_info;
        commitment = mimc2(t_nullifier, nonce);
        if (nullifier == t_nullifier) {
          if (input_commitment != null) {
            throw "æœ‰é‡å¤!";
          }
          [input_commitment, input_nonce] = [commitment, nonce];
        }
      } else {
        throw "Transcript æ— æ•ˆ + " + str(transcript);
      }
      if (commitment == null) {  
        throw "commitmentä¸ºç©º!";
      }
      tree.insert(commitment);
    }

    // è·å–æˆ‘ä»¬çš„é¡¹ç›®çš„è¯æ˜ã€‚
    if (input_commitment == null) {
      throw "nullifier åœ¨æˆ‘ä»¬çš„ transcript ä¸­æœªæ‰¾åˆ°";
    }
    const path = tree.path(input_commitment);
    const output = {
      digest: tree.digest,
      nullifier: nullifier,
      nonce: input_nonce,
    };
    for (let i = 0; i < depth; i++) {
      let [s, d] = path[i];
      output['sibling[' + i + ']'] = s.toString();
      output['direction[' + i + ']'] = (d) ? "1" : "0";
    }
    return output;
}

```

è¾“å…¥å‚æ•°ï¼š

- depthï¼šMerkleæ ‘çš„æ·±åº¦
- transcriptï¼šåŒ…å«æ‰€æœ‰æ·»åŠ åˆ°æ ‘ä¸­çš„commitmentçš„åˆ—è¡¨ã€‚æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœæ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™è¯¥å…ƒç´ æ˜¯commitmentï¼›å¦åˆ™ï¼Œæ•°ç»„å°†æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œåˆ†åˆ«æ˜¯nullifierå’Œnonceã€‚è¯¥åˆ—è¡¨ä¸åŒ…å«é‡å¤çš„nullifieræˆ–commitmentç­‰ã€‚
- nullifierï¼šè¦ä¸ºå…¶æ‰“å°éªŒè¯å™¨è¾“å…¥çš„nullifierã€‚è¯¥nullifierå¿…é¡»å‡ºç°åœ¨transcriptä¸­ã€‚

è¿”å›å€¼ï¼š

- ä¸€ä¸ªå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š { "digest": ..., "nullifier": ..., "nonce": ..., "sibling[0]": ..., "sibling[1]": ..., ... "sibling[depth-1]": ..., "direction[0]": ..., "direction[1]": ..., ... "direction[depth-1]": ..., } å…¶ä¸­ï¼Œæ¯ä¸ª...éƒ½æ˜¯è¡¨ç¤ºæ•°å­—çš„å­—ç¬¦ä¸²ï¼Œä»£è¡¨ä»¥ä¸‹ä¿¡æ¯ï¼š
- digestï¼šå°†transcriptåº”ç”¨äºæ•´ä¸ªæ ‘åçš„æ‘˜è¦ã€‚
- nullifierï¼šè¢«æ¶ˆè´¹çš„coinçš„nullifierã€‚
- nonceï¼šè¯¥coinçš„nonceã€‚
- sibling[i]ï¼šåœ¨ä»åº•éƒ¨åˆ°coin commitmentçš„è·¯å¾„ä¸Šä½äºç¬¬iå±‚çš„èŠ‚ç‚¹çš„siblingã€‚
- direction[i]ï¼šè¯¥èŠ‚ç‚¹çš„siblingæ˜¯å¦åœ¨å·¦è¾¹ã€‚"sibling"é”®ç›´æ¥å¯¹åº”äºSparseMerkleTreeè·¯å¾„ä¸­çš„siblingsã€‚"direction"é”®è¡¨ç¤ºSparseMerkleTreeè·¯å¾„ä¸­çš„å¸ƒå°”æ–¹å‘ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²è¡¨ç¤ºçš„æ•´æ•°ï¼ˆ"0"æˆ–"1"ï¼‰

å‡½æ•°çš„ä¸»è¦æ“ä½œå¦‚ä¸‹ï¼š

- åˆ›å»ºMerkleæ ‘ã€‚æ ¹æ®ç»™å®šçš„æ·±åº¦åˆ›å»ºäº†ä¸€ä¸ª`SparseMerkleTree`å®ä¾‹`tree`ã€‚
- å°†`transcript`ä¸­çš„`commitment`æ·»åŠ åˆ°Merkleæ ‘ä¸­ã€‚å¯¹`transcript`ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œå¤„ç†ã€‚å¦‚æœå…ƒç´ æ•°ç»„åªåŒ…å«ä¸€ä¸ªå…ƒç´ ï¼Œå°†è¯¥å…ƒç´ ä½œä¸º`commitment`ç›´æ¥æ·»åŠ åˆ°æ ‘ä¸­ã€‚å¦‚æœå…ƒç´ æ•°ç»„åŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼Œåˆ†åˆ«æ˜¯`t_nullifier`å’Œ`nonce`ï¼Œåˆ™ä½¿ç”¨`mimc2()`å‡½æ•°è®¡ç®—`commitment`ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ ‘ä¸­ã€‚åœ¨æ·»åŠ è¿‡ç¨‹ä¸­ï¼Œè®°å½•ä¸‹ä¸ç»™å®š`nullifier`ç›¸åŒ¹é…çš„`commitment`å’Œå¯¹åº”çš„`nonce`ã€‚
- æŸ¥æ‰¾ç»™å®š`nullifier`å¯¹åº”çš„`commitment`å¹¶è·å–Merkleè·¯å¾„ã€‚é€šè¿‡è°ƒç”¨`tree.path(input_commitment)`è·å–è¾“å…¥`commitment`çš„Merkleè·¯å¾„ã€‚å¹¶å°†è®¡ç®—çš„`digest`ã€`nullifier`ã€`nonce`ä»¥åŠMerkleè·¯å¾„çš„siblingså’Œdirectionsä¿å­˜åˆ°`output`å¯¹è±¡ä¸­ã€‚
- ç”ŸæˆåŒ…å«Merkleè·¯å¾„ä¿¡æ¯çš„outputå¯¹è±¡ã€‚è¿”å›outputå¯¹è±¡ä½œä¸ºå‡½æ•°çš„è¾“å‡ºç»“æœã€‚

### èµå›è¯æ˜

ä½¿ç”¨circomå’Œsnarkjsåˆ›å»ºä¸€ä¸ªSNARKç”¨æ¥è¯æ˜æ·±åº¦ä¸º10çš„Merkleæ ‘ä¸­å­˜åœ¨ä¸`test/compute_spend_input/transcript3.txt`ç›¸å¯¹åº”çš„`nullifire"10137284576094"`ã€‚ä½¿ç”¨æ·±åº¦ä¸º 10ï¼ˆä½ å°†åœ¨ test/circircuits/spend10.circom ä¸­æ‰¾åˆ° Spend ç”µè·¯çš„ depth-10 å®ä¾‹åŒ–ï¼‰ã€‚

è¦æ±‚ï¼šå°†ä½ çš„éªŒè¯å¯†é’¥æ”¾åœ¨ `artifacts/verifier_key_spend.json `ä¸­ï¼Œå°†ä½ çš„è¯æ˜æ”¾åœ¨ `artifacts/proof_spend.json` ä¸­ã€‚

#### Step1ï¼šç”Ÿæˆinput.js

ä¸ºäº†ç”Ÿæˆinputï¼Œéœ€è¦å…ˆå®Œæˆ`src/sompute_spend_input.js`æ–‡ä»¶å½“ä¸­çš„`computeInput(depth,transcript,nullifier)`ã€‚

ä½¿ç”¨åˆšæ‰å†™çš„`src\compute_spend_inputs.js`ï¼Œåœ¨`src\`ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ

`node compute_spend_inputs.js 10 '../test/compute_spend_inputs/transcript3.txt' 10137284576094 -o input.json`

**ç”Ÿæˆçš„input.jsonå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

![image-20231218214159891](assets/image-20231218214159891.png)

#### Step2 ä½¿ç”¨`test/circuits/spend.circom`è¿›è¡Œå®ä¾‹åŒ–

é¦–å…ˆåœ¨spend.circomé‡Œä¸´æ—¶æ·»åŠ ä¸€å¥ä»£ç ï¼š

```js
component main = Spend(10);
```

ç„¶åè¿è¡Œå‘½ä»¤ï¼š`circom spend.circom -o circuit.json`

å³å¯è¿›è¡Œå®ä¾‹åŒ–ã€‚

â€‹	ğŸ’»æ³¨ï¼š**åœ¨æœ¬æ¬¡å®éªŒï¼Œæˆ‘ä»¬äºŒäººçš„åšæ³•ç•¥æœ‰ä¸åŒï¼Œä¸€äººæ˜¯å°†spend.circomæ‹†åˆ†æˆå››ä¸ªæ–‡ä»¶ï¼š**

```apl
spend0.circom
spend4.circom
spend10.circom
spend25.circom
```

â€‹	**å¦ä¸€äººåˆ™æ˜¯åªä½¿ç”¨spend.circomï¼Œå› ä¸ºtestæ–‡ä»¶ä¸­å·²ç»æ‹†åˆ†æˆå››ä¸ªcircomæ–‡ä»¶ï¼Œå¹¶ä¸”å››ä¸ªtestæ–‡ä»¶éƒ½å¯¹spend.circomè¿›è¡Œäº†å¼•ç”¨ã€‚**

#### Step3 å¼€å§‹éªŒè¯ä¸è¯æ˜

- å½“å‰æ–‡ä»¶å¤¹ä¸‹ä½¿ç”¨`snarkjs setup`å»ºç«‹cirsuit.jsonçš„snarkjs

![image-20231218092919707](assets\image-20231218092919707.png)

- è®¡ç®—å‡ºwitnessï¼ˆç›®å‡»è¯äººï¼‰ï¼Œè¯´æ˜æˆ‘ä»¬ç¡®å®æœ‰è¿™ä¸ªçŸ¥è¯†.éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¾—å…ˆæœ‰ç›¸åº”çš„`input.json`

  - ç”Ÿæˆ`input.json`æ–‡ä»¶

  æ–¹æ³•å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œç”Ÿæˆåçš„æ•°æ®ï¼š

  ![image-20231218100356033](assets\image-20231218100356033.png)

  - ç”Ÿæˆ`witness.json`æ–‡ä»¶ã€‚

    ä½¿ç”¨æŒ‡ä»¤`snarkjs calculatewitness`æ¥ç”Ÿæˆ`witness.json`

![image-20231218100428028](assets\image-20231218100428028.png)

- ä½¿ç”¨æŒ‡ä»¤`snarkjs proof`ç”Ÿæˆè¯æ®ã€‚è¿™æ¡æŒ‡ä»¤ä¼šé»˜è®¤åœ°ä½¿ç”¨`proving_key.json`å’Œ`witness.json`å»åˆ›å»º`proof.json`å’Œ`public.json`ã€‚å…¶ä¸­ï¼Œ`proof.json`æ–‡ä»¶ä¹‹ä¸­åŒ…å«ç€ç¡®å®çš„è¯æ®ã€‚`public.json`æ–‡ä»¶å°†ä¼šåŒ…å«å…¬å…±çš„è¾“å…¥å’Œå…¬å…±çš„è¾“å‡º

![image-20231218100612776](assets\image-20231218100612776.png)

å…¶ä¸­ï¼Œ`verification_key.json`å’Œ`proof.json`å°±æ˜¯æˆ‘ä»¬æœ€ç»ˆæƒ³è¦çš„ã€‚

è¯¦è§`artifacts/verifier_key_spend.json `ä¸ `artifacts/proof_spend.json` ã€‚

### æµ‹è¯•

ä½¿ç”¨`npm test`è¿›è¡Œæµ‹è¯•ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œè¯´æ˜æˆ‘ä»¬çš„ç®€å•çš„ç‰ˆæœ¬çš„èŠ±è´¹ Tornado çš„ç”µè·¯å·²ç»åˆ¶ä½œå¥½å•¦~

![image-20231212205729343](assets\image-20231212205729343.png)

## æ€»ç»“

### æˆæœä¸åæ€

æœ¬æ¬¡å®éªŒæˆåŠŸå®ç°äº†åŸºäº zk-SNARKs çš„ç§æœ‰äº‹åŠ¡å¤„ç†ï¼Œé€šè¿‡ä½¿ç”¨ circom å’Œ snarkjs å·¥å…·ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†ç®—æœ¯ç”µè·¯çš„æ„å»ºå’ŒéªŒè¯è¿‡ç¨‹ã€‚åœ¨å®éªŒä¸­ï¼Œæˆ‘ä»¬ä¸ä»…é…ç½®äº†å¿…è¦çš„ç¯å¢ƒï¼Œè¿˜å­¦ä¹ äº†å¦‚ä½•åœ¨å®é™…åŒºå—é“¾åº”ç”¨ä¸­å®ç°éšç§ä¿æŠ¤ã€‚

- **å®è·µ zk-SNARKs**ï¼šæˆ‘ä»¬æŒæ¡äº†å¦‚ä½•ä½¿ç”¨ zk-SNARKs æ¥ç”Ÿæˆå’ŒéªŒè¯ç”µè·¯çš„æ»¡æ„åº¦è¯æ˜ï¼Œè¿™æ˜¯åŒºå—é“¾éšç§äº¤æ˜“çš„æ ¸å¿ƒæŠ€æœ¯ã€‚
- **ç®—æœ¯ç”µè·¯çš„åº”ç”¨**ï¼šé€šè¿‡æ„å»ºå’Œæµ‹è¯•ä¸åŒçš„ç®—æœ¯ç”µè·¯ï¼ˆå¦‚ IfThenElse å’Œ SelectiveSwitchï¼‰ï¼Œæˆ‘ä»¬åŠ æ·±äº†å¯¹ç”µè·¯é€»è¾‘å’ŒåŠŸèƒ½çš„ç†è§£ã€‚

### æŒ‘æˆ˜ä¸æ”¶è·

è¿™æ¬¡å®éªŒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€äº›æŒ‘æˆ˜ï¼Œä½†ä¹Ÿå› æ­¤è·å¾—äº†å®è´µçš„å­¦ä¹ ç»éªŒï¼š

- **ç¯å¢ƒé…ç½®**ï¼šåˆå§‹çš„ç¯å¢ƒé…ç½®éœ€è¦ç²¾ç¡®å’Œç»†è‡´ï¼Œè¿™å¯¹æˆ‘ä»¬ç†è§£æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œæ–¹å¼å’Œä¾èµ–å…³ç³»éå¸¸æœ‰å¸®åŠ©ã€‚
- **ç†è®ºä¸å®è·µçš„ç»“åˆ**ï¼šé€šè¿‡å®é™…æ“ä½œï¼Œæˆ‘ä»¬å°†ç†è®ºçŸ¥è¯†ä¸å®è·µç›¸ç»“åˆï¼Œè¿™ä¸ä»…åŠ æ·±äº†å¯¹è¯¾ç¨‹ç†è®ºçš„ç†è§£ï¼Œä¹Ÿæå‡äº†æˆ‘ä»¬è§£å†³å®é™…é—®é¢˜çš„èƒ½åŠ›ã€‚
- **è°ƒè¯•ä¸è§£å†³é—®é¢˜**ï¼šåœ¨æ„å»ºç”µè·¯å’Œç”Ÿæˆè¯æ˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦ä¼šäº†å¦‚ä½•è°ƒè¯•å’Œè§£å†³å‡ºç°çš„é—®é¢˜ï¼Œè¿™å¯¹æå‡æˆ‘ä»¬çš„é—®é¢˜è§£å†³æŠ€èƒ½éå¸¸æœ‰ç›Šã€‚

### æœªæ¥å±•æœ›

è¿™æ¬¡å®éªŒè™½ç„¶å®Œæˆäº†ï¼Œä½†å®ƒå¼€å¯äº†æˆ‘ä»¬å¯¹åŒºå—é“¾æŠ€æœ¯æ›´æ·±å±‚æ¬¡æ¢ç´¢çš„å¤§é—¨ï¼š

- **æ·±å…¥å­¦ä¹  zk-SNARKs**ï¼šæœªæ¥å¯ä»¥æ›´æ·±å…¥åœ°æ¢ç´¢ zk-SNARKs åœ¨ä¸åŒåŒºå—é“¾åº”ç”¨ä¸­çš„ä½¿ç”¨ï¼Œå¦‚æŠ•ç¥¨ç³»ç»Ÿã€èº«ä»½éªŒè¯ç­‰ã€‚
- **æ¢ç´¢å…¶ä»–åŒºå—é“¾æŠ€æœ¯**ï¼šé™¤äº† zk-SNARKsï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–æœ‰è¶£çš„åŒºå—é“¾æŠ€æœ¯å€¼å¾—æ¢ç´¢ï¼Œå¦‚å…¶ä»–å½¢å¼çš„é›¶çŸ¥è¯†è¯æ˜ã€æ™ºèƒ½åˆçº¦çš„ä¼˜åŒ–ç­‰ã€‚

æ€»çš„æ¥è¯´ï¼Œè¿™æ¬¡å®éªŒä¸ä»…æé«˜äº†æˆ‘ä»¬å¯¹åŒºå—é“¾éšç§ä¿æŠ¤æŠ€æœ¯çš„ç†è§£ï¼Œä¹Ÿä¸ºæˆ‘ä»¬æœªæ¥åœ¨åŒºå—é“¾é¢†åŸŸçš„æ·±å…¥å­¦ä¹ å’Œç ”ç©¶æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ã€‚